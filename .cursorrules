# üè∞ PROJECT: Portuguese Stonework Database (mttc_project)


# ‚öôÔ∏è STACK: Next.js 14+ (App Router), TypeScript, Drizzle ORM, Supabase (Postgres+PostGIS), Docker


# 1. CORE PHILOSOPHY & ARCHITECTURE



* **Academic Rigor:** This is a scientific database. Data integrity is paramount.
* **Server First:** Default to React Server Components (RSC). Only use 'use client' for interactive islands (Maps, Forms, Toggles).
* **Core + Extension Pattern:**
    * constructions table = Generic data (Location, ID, Status, Slugs).
    * mills_data table = Specific domain data (Typology, Mechanism) based on the scientific inventory sheet.
    * Do NOT mix specific columns into the generic table.
* **Internationalization:** All UI text must be wrapped in next-intl hooks (t('key')). Never hardcode strings.


# 2. CODING STANDARDS (STRICT TYPESCRIPT)



* **Strict Mode:** noImplicitAny is strictly enforced.
    * ‚ùå NEVER use any.
    * ‚úÖ Use unknown with narrowing, or define Zod schemas.
    * ‚úÖ Create named interfaces in src/types/ for complex data structures.
* **Exports:** Use Named Exports (export const MillCard = ...) to prevent refactoring errors.
* **Comments:** Comment complex logic, especially Drizzle queries and GIS calculations.


# 3. TECH STACK SPECIFICS


## 3.1 Next.js App Router



* Use app/[locale]/... for all routes.
* Use loading.tsx and error.tsx for granular UI states.
* Use Server Actions ('use server') for all data mutations. Do NOT create API routes (pages/api) unless strictly necessary.


## 3.2 Drizzle ORM & Database



* **Querying:** Use the Query Builder syntax (db.query.constructions.findMany(...)) over raw SQL.
* **Enums:** Use Drizzle Enums for all fixed taxonomies (e.g., typologyEnum, accessEnum, materialEnum).
* **PostGIS:** When handling coordinates, ensure strictly typed [Lat, Lng] tuples or GeoJSON objects.
* **Validation:** Every DB insert/update must be validated with Zod schemas matching the Drizzle definitions.


## 3.3 UI & Styling



* **Tailwind:** Use utility classes. Sort them: Layout -> Spacing -> Visuals.
* **Shadcn/UI:** Use these primitives for all interactive elements.
* **Icons:** Use lucide-react exclusively.
* **Maps:** Use react-leaflet.
    * ‚ùå NEVER suggest Google Maps.
    * ‚úÖ Lazy load map components (next/dynamic) to avoid SSR window errors.


# 4. DATA & ASSET CONVENTIONS



* **Images:**
    * NEVER store binary files in the DB.
    * Store strings: storage_path pointing to Supabase Storage.
    * Naming Convention: /{category}/{slug}/{timestamp}.jpg
* **URLs (SEO):**
    * Public URLs must use slugs (/mill/azenha-do-rio), NOT UUIDs.
* **Taxonomy:**
    * Store "Translation Keys" in the DB (e.g., mat_granite), not raw text ("Granite").
    * The Frontend handles localization via next-intl.


# 5. ERROR HANDLING & LOGGING



* Wrap Server Actions in 'try/catch' blocks.
* Return standardized objects: { success: boolean, data?: T, error?: string }.
* Log errors to console with context: console.error('[ActionName]:', error).


# 6. FILE STRUCTURE MAP



* src/app: Routes and Pages
* src/components/ui: Shadcn primitives
* src/components/features: Domain specific components (e.g., MillMap, MillForm)
* src/db: Drizzle Schema and Connection
* src/lib: Utilities (Supabase, Auth)
* src/actions: Server Actions
* src/types: TypeScript interfaces
* messages: Translation JSON files (pt.json, en.json)


**CURRENT CONTEXT: PHASE 5.9.1 - UI/UX REFINEMENT**
* **Mission:** Transform the functional dashboard into a premium, academic tool.
* **Tech Constraints:** Next.js 14 RSC-First, Tailwind CSS, Shadcn/UI, `next-intl`.
* **Rules of Engagement:**
    1.  **NO SCHEMA CHANGES:** The Drizzle schema is parity-validated. Focus on the View and Controller layers.
    2.  **i18n EVERYTHING:** Every string in the UI must use the `t('key')` pattern.
    3.  **Form Ergonomics:** Optimize the `mills_data` entry forms. Use multi-step patterns or logical groupings based on the `mills_data_spec`.
    4.  **Map Interactivity:** Ensure Leaflet/OSM markers are performant and the Sidebar syncs state with the URL slugs.

**WORKING NOW: PHASE 5.9.1 - CONDITIONAL FORM ERGONOMICS**
* **Context:** Refining `dashboard/add` (specifically the 'Architecture' section within 'Technical Specs').
* **Objective:** Implement conditional visibility and logical grouping for stone materials and roof structures.

**UI LOGIC REQUIREMENTS:**
1. **Construction Technique Group:**
   - If a 'Construction Technique' is selected, reveal a checkbox group: "Stone Type".
   - Options: [Granite, Schist, Other].
   - If "Other" is checked, reveal a Text Input for the manual description.
   - Mapping: Map values to the `mills_data` material fields. "Other" text should be stored in the appropriate description/notes column.

2. **Consolidated Roof Section:**
   - Merge "Roof Shape" and "Roof Material" into a single UI block.
   - Primary Selection (Radio/Select): [Fake Dome (Falsa C√∫pula), Stone (Lageado), Gable Roof (Duas √Åguas)].
   - Conditional Logic: If "Gable Roof" is selected, reveal a checkbox group for specific materials: [Lusa, Marselha, Meia-cana].

3. **Technical Constraints:**
   - **i18n:** All new labels (`lusa`, `meia-cana`, `falsa_cupula`, etc.) must be added to `messages/pt.json` and `messages/en.json`. Use `next-intl`.
   - **State Management:** Use `react-hook-form` (already in the stack) with `watch` or `useWatch` for conditional rendering.
   - **Styling:** Tailwind CSS only. Use Shadcn/UI components for checkboxes and inputs.
   - **Data Integrity:** Do NOT modify `schema.ts`. Ensure values are cast or mapped to fit the existing Enums or text columns. If a sub-type (like 'lusa') doesn't have a specific Enum, ensure it is handled gracefully in a general material field or description.

**STRICT RULE:** Use Server-First patterns where possible, but use `'use client'` for this form component to handle the interactivity.

**CORRECTION: CONSTRUCTION TECHNIQUE ERGONOMICS**
* **Task:** Refactor the "Construction Technique" section in `dashboard/add/page.tsx` to match the "Roof" section pattern.
* **Logic:** 1. **Replace Select with RadioGroup:** Options: [Dry Stone (Pedra Seca), Mortared Stone (Pedra com Argamassa), Mixed/Other (Misto/Outro)].
    2. **Technique 'Other' Logic:** If "Mixed/Other" is selected, reveal a Text Input for `construction_technique_description`.
    3. **Stone Type Visibility:** Keep the "Stone Type" checkboxes visible whenever a stone-based technique is active.
    4. **i18n:** Ensure the new labels use keys from `pt.json` and `en.json`.