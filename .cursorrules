# üè∞ PROJECT: Portuguese Stonework Database (mttc_project)


# ‚öôÔ∏è STACK: Next.js 14+ (App Router), TypeScript, Drizzle ORM, Supabase (Postgres+PostGIS), Docker


# 1. CORE PHILOSOPHY & ARCHITECTURE



* **Academic Rigor:** This is a scientific database. Data integrity is paramount.
* **Server First:** Default to React Server Components (RSC). Only use 'use client' for interactive islands (Maps, Forms, Toggles).
* **Core + Extension Pattern:**
    * constructions table = Generic data (Location, ID, Status, Slugs).
    * mills_data table = Specific domain data (Typology, Mechanism) based on the scientific inventory sheet.
    * Do NOT mix specific columns into the generic table.
* **Internationalization:** All UI text must be wrapped in next-intl hooks (t('key')). Never hardcode strings.


# 2. CODING STANDARDS (STRICT TYPESCRIPT)



* **Strict Mode:** noImplicitAny is strictly enforced.
    * ‚ùå NEVER use any.
    * ‚úÖ Use unknown with narrowing, or define Zod schemas.
    * ‚úÖ Create named interfaces in src/types/ for complex data structures.
* **Exports:** Use Named Exports (export const MillCard = ...) to prevent refactoring errors.
* **Comments:** Comment complex logic, especially Drizzle queries and GIS calculations.


# 3. TECH STACK SPECIFICS


## 3.1 Next.js App Router



* Use app/[locale]/... for all routes.
* Use loading.tsx and error.tsx for granular UI states.
* Use Server Actions ('use server') for all data mutations. Do NOT create API routes (pages/api) unless strictly necessary.


## 3.2 Drizzle ORM & Database



* **Querying:** Use the Query Builder syntax (db.query.constructions.findMany(...)) over raw SQL.
* **Enums:** Use Drizzle Enums for all fixed taxonomies (e.g., typologyEnum, accessEnum, materialEnum).
* **PostGIS:** When handling coordinates, ensure strictly typed [Lat, Lng] tuples or GeoJSON objects.
* **Validation:** Every DB insert/update must be validated with Zod schemas matching the Drizzle definitions.


## 3.3 UI & Styling



* **Tailwind:** Use utility classes. Sort them: Layout -> Spacing -> Visuals.
* **Shadcn/UI:** Use these primitives for all interactive elements.
* **Icons:** Use lucide-react exclusively.
* **Maps:** Use react-leaflet.
    * ‚ùå NEVER suggest Google Maps.
    * ‚úÖ Lazy load map components (next/dynamic) to avoid SSR window errors.


# 4. DATA & ASSET CONVENTIONS



* **Images:**
    * NEVER store binary files in the DB.
    * Store strings: storage_path pointing to Supabase Storage.
    * Naming Convention: /{category}/{slug}/{timestamp}.jpg
* **URLs (SEO):**
    * Public URLs must use slugs (/mill/azenha-do-rio), NOT UUIDs.
* **Taxonomy:**
    * Store "Translation Keys" in the DB (e.g., mat_granite), not raw text ("Granite").
    * The Frontend handles localization via next-intl.


# 5. ERROR HANDLING & LOGGING



* Wrap Server Actions in 'try/catch' blocks.
* Return standardized objects: { success: boolean, data?: T, error?: string }.
* Log errors to console with context: console.error('[ActionName]:', error).


# 6. FILE STRUCTURE MAP



* src/app: Routes and Pages
* src/components/ui: Shadcn primitives
* src/components/features: Domain specific components (e.g., MillMap, MillForm)
* src/db: Drizzle Schema and Connection
* src/lib: Utilities (Supabase, Auth)
* src/actions: Server Actions
* src/types: TypeScript interfaces
* messages: Translation JSON files (pt.json, en.json)


**CURRENT CONTEXT (PHASE 4: DISCOVERY COMPLETE & VERIFIED)**
* **Audit Results:** Security Shield (404 for drafts), i18n Handshake, and GIS Consistency are all SUCCESSFUL.
* **Bug Fix:** Sidebar filter toggling (URL Search Params) is now repaired.
* **Navigation:** Slug-based routing (/mill/[slug]) is the primary discovery method.

**WORKING NOW CONTEXT (PHASE 4.5: THE IMAGE GALLERY)**
* **Focus:** Visual Assets & Supabase Storage.
* **Technical Mandate:** 1. **Schema Migration:** Add `main_image` (text) and `gallery_images` (text array) columns to the `constructions` table.
    2. **Storage Helper:** Create `src/lib/storage.ts` to generate Public URLs for assets stored in the 'constructions' bucket.
    3. **UI Integration:** Display the `main_image` in the Map Popups and as a Hero section in the Detail Page.
    4. **Optimization:** Use `next/image` for all rendering. Binary files are NEVER in the DB.
* **Infrastructure:** Local Docker (DB) + Supabase Storage (Visuals). 
* **Schema:** `constructions` table needs a `main_image` column (text).
* **Task:** Implement `src/lib/storage.ts` to handle CDN URL generation from the 'constructions' bucket.
* **Task:** Integrate images into `MillMap` popups and the `mill/[slug]` detail page.
* **Rule:** Use `next/image` for all rendering. Never store binary data in the database.