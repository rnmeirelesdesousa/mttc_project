# ðŸ° PROJECT: Portuguese Stonework Database (mttc_project)


# âš™ï¸ STACK: Next.js 14+ (App Router), TypeScript, Drizzle ORM, Supabase (Postgres+PostGIS), Docker


# 1. CORE PHILOSOPHY & ARCHITECTURE



* **Academic Rigor:** This is a scientific database. Data integrity is paramount.
* **Server First:** Default to React Server Components (RSC). Only use 'use client' for interactive islands (Maps, Forms, Toggles).
* **Core + Extension Pattern:**
    * constructions table = Generic data (Location, ID, Status, Slugs).
    * mills_data table = Specific domain data (Typology, Mechanism) based on the scientific inventory sheet.
    * Do NOT mix specific columns into the generic table.
* **Internationalization:** All UI text must be wrapped in next-intl hooks (t('key')). Never hardcode strings.


# 2. CODING STANDARDS (STRICT TYPESCRIPT)



* **Strict Mode:** noImplicitAny is strictly enforced.
    * âŒ NEVER use any.
    * âœ… Use unknown with narrowing, or define Zod schemas.
    * âœ… Create named interfaces in src/types/ for complex data structures.
* **Exports:** Use Named Exports (export const MillCard = ...) to prevent refactoring errors.
* **Comments:** Comment complex logic, especially Drizzle queries and GIS calculations.


# 3. TECH STACK SPECIFICS


## 3.1 Next.js App Router



* Use app/[locale]/... for all routes.
* Use loading.tsx and error.tsx for granular UI states.
* Use Server Actions ('use server') for all data mutations. Do NOT create API routes (pages/api) unless strictly necessary.


## 3.2 Drizzle ORM & Database



* **Querying:** Use the Query Builder syntax (db.query.constructions.findMany(...)) over raw SQL.
* **Enums:** Use Drizzle Enums for all fixed taxonomies (e.g., typologyEnum, accessEnum, materialEnum).
* **PostGIS:** When handling coordinates, ensure strictly typed [Lat, Lng] tuples or GeoJSON objects.
* **Validation:** Every DB insert/update must be validated with Zod schemas matching the Drizzle definitions.


## 3.3 UI & Styling



* **Tailwind:** Use utility classes. Sort them: Layout -> Spacing -> Visuals.
* **Shadcn/UI:** Use these primitives for all interactive elements.
* **Icons:** Use lucide-react exclusively.
* **Maps:** Use react-leaflet.
    * âŒ NEVER suggest Google Maps.
    * âœ… Lazy load map components (next/dynamic) to avoid SSR window errors.


# 4. DATA & ASSET CONVENTIONS



* **Images:**
    * NEVER store binary files in the DB.
    * Store strings: storage_path pointing to Supabase Storage.
    * Naming Convention: /{category}/{slug}/{timestamp}.jpg
* **URLs (SEO):**
    * Public URLs must use slugs (/mill/azenha-do-rio), NOT UUIDs.
* **Taxonomy:**
    * Store "Translation Keys" in the DB (e.g., mat_granite), not raw text ("Granite").
    * The Frontend handles localization via next-intl.


# 5. ERROR HANDLING & LOGGING



* Wrap Server Actions in 'try/catch' blocks.
* Return standardized objects: { success: boolean, data?: T, error?: string }.
* Log errors to console with context: console.error('[ActionName]:', error).


# 6. FILE STRUCTURE MAP



* src/app: Routes and Pages
* src/components/ui: Shadcn primitives
* src/components/features: Domain specific components (e.g., MillMap, MillForm)
* src/db: Drizzle Schema and Connection
* src/lib: Utilities (Supabase, Auth)
* src/actions: Server Actions
* src/types: TypeScript interfaces
* messages: Translation JSON files (pt.json, en.json)


**CURRENT CONTEXT (PHASE 4: PUBLIC CATALOG & SEARCH)**
* **Infrastructure:** Local Docker (mttc_db) with PostGIS.
* **Security:** `mock-session` cookie handles admin/researcher state; public routes remain open.
* **Technical Mandate:**
    1. **Dynamic Routing:** Implement `src/app/[locale]/(public)/mill/[slug]/page.tsx` using Drizzle to fetch data by slug, not UUID.
    2. **Map Component:** Build a Client Component `MillMap` using Leaflet/OpenStreetMap. No Google Maps.
    3. **Search Logic:** Write Server Actions for filtering mills based on the `mills_data` taxonomy.
    4. **i18n:** Every string must use `next-intl`. No hardcoded Portuguese or English in the JSX.
    5. **GIS:** Utilize PostGIS via Drizzle for any coordinate-based sorting or display.

WORKING NOW CONTEXT (PHASE 4: PUBLIC CATALOG & SEARCH)

Focus: Frontend Implementation & GIS logic.

Technical Mandate: > 1. Dynamic Routing: Implement src/app/[locale]/(public)/mill/[slug]/page.tsx. Use Drizzle to fetch data where slug matches the param. 2. Leaflet Integration: Build a Client Component MillMap in src/components/features/. Use react-leaflet or vanilla Leaflet. Strictly No Google Maps. 3. Server Actions: Create getFilteredMills in src/actions/public.ts to handle taxonomy-based search (PostGIS ST_AsText or ST_X/Y for coordinate extraction). 4. i18n: Every label must use next-intl keys from messages/*.json.

Infrastructure: Maintain use of mttc_db via Docker. Do not attempt to call Supabase Auth APIs; continue using the mock-session cookie logic.