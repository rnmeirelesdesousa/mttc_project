# üè∞ PROJECT: Portuguese Stonework Database (mttc_project)


# ‚öôÔ∏è STACK: Next.js 14+ (App Router), TypeScript, Drizzle ORM, Supabase (Postgres+PostGIS), Docker


# 1. CORE PHILOSOPHY & ARCHITECTURE



* **Academic Rigor:** This is a scientific database. Data integrity is paramount.
* **Server First:** Default to React Server Components (RSC). Only use 'use client' for interactive islands (Maps, Forms, Toggles).
* **Core + Extension Pattern:**
    * constructions table = Generic data (Location, ID, Status, Slugs).
    * mills_data table = Specific domain data (Typology, Mechanism) based on the scientific inventory sheet.
    * Do NOT mix specific columns into the generic table.
* **Internationalization:** All UI text must be wrapped in next-intl hooks (t('key')). Never hardcode strings.


# 2. CODING STANDARDS (STRICT TYPESCRIPT)



* **Strict Mode:** noImplicitAny is strictly enforced.
    * ‚ùå NEVER use any.
    * ‚úÖ Use unknown with narrowing, or define Zod schemas.
    * ‚úÖ Create named interfaces in src/types/ for complex data structures.
* **Exports:** Use Named Exports (export const MillCard = ...) to prevent refactoring errors.
* **Comments:** Comment complex logic, especially Drizzle queries and GIS calculations.


# 3. TECH STACK SPECIFICS


## 3.1 Next.js App Router



* Use app/[locale]/... for all routes.
* Use loading.tsx and error.tsx for granular UI states.
* Use Server Actions ('use server') for all data mutations. Do NOT create API routes (pages/api) unless strictly necessary.


## 3.2 Drizzle ORM & Database



* **Querying:** Use the Query Builder syntax (db.query.constructions.findMany(...)) over raw SQL.
* **Enums:** Use Drizzle Enums for all fixed taxonomies (e.g., typologyEnum, accessEnum, materialEnum).
* **PostGIS:** When handling coordinates, ensure strictly typed [Lat, Lng] tuples or GeoJSON objects.
* **Validation:** Every DB insert/update must be validated with Zod schemas matching the Drizzle definitions.


## 3.3 UI & Styling



* **Tailwind:** Use utility classes. Sort them: Layout -> Spacing -> Visuals.
* **Shadcn/UI:** Use these primitives for all interactive elements.
* **Icons:** Use lucide-react exclusively.
* **Maps:** Use react-leaflet.
    * ‚ùå NEVER suggest Google Maps.
    * ‚úÖ Lazy load map components (next/dynamic) to avoid SSR window errors.


# 4. DATA & ASSET CONVENTIONS



* **Images:**
    * NEVER store binary files in the DB.
    * Store strings: storage_path pointing to Supabase Storage.
    * Naming Convention: /{category}/{slug}/{timestamp}.jpg
* **URLs (SEO):**
    * Public URLs must use slugs (/mill/azenha-do-rio), NOT UUIDs.
* **Taxonomy:**
    * Store "Translation Keys" in the DB (e.g., mat_granite), not raw text ("Granite").
    * The Frontend handles localization via next-intl.


# 5. ERROR HANDLING & LOGGING



* Wrap Server Actions in 'try/catch' blocks.
* Return standardized objects: { success: boolean, data?: T, error?: string }.
* Log errors to console with context: console.error('[ActionName]:', error).


# 6. FILE STRUCTURE MAP



* src/app: Routes and Pages
* src/components/ui: Shadcn primitives
* src/components/features: Domain specific components (e.g., MillMap, MillForm)
* src/db: Drizzle Schema and Connection
* src/lib: Utilities (Supabase, Auth)
* src/actions: Server Actions
* src/types: TypeScript interfaces
* messages: Translation JSON files (pt.json, en.json)


## OLD CONTEXT (PHASE 2: DATA ARCHITECTURE)
* **Status:** Phase 1 Complete. Docker & PostGIS are running.
* **Focus:** Database Modeling & Drizzle ORM Implementation.
* **Architecture Pattern:** "Core + Extension" (Class Table Inheritance).
  - `constructions` (Parent): UUID, Slug, Geometry (PostGIS Point).
  - `mills_data` (Child): 1:1 relation, specific attributes (typology, mechanism).
  - `construction_translations` (i18n): Text content in rows, not columns.
* **Tech Constraints:**
  - Use `drizzle-orm/postgres-js`.
  - Strict TypeScript Enums for taxonomy (e.g., `TypologyEnum`).
  - URLs must be SEO-friendly slugs (not UUIDs).
  - Binary files (images) NEVER go in DB.


**CURRENT CONTEXT (PHASE 3: GOVERNANCE & SECURITY)**
* **Focus:** Authentication & Access Control (RBAC).
* **Status:** Phase 2 (Data) is Complete. DB is seeded and verified.
* **Immediate Tasks (Roadmap Section 3):**
    1.  **Profiles Table:** Create a `profiles` table linked to `auth.users` (Foreign Key) to store custom roles ('admin', 'researcher', 'public').
    2.  **RLS Policies (Row Level Security):** Enable strict RLS on ALL tables.
        * *Public Rule:* `constructions` are viewable by `anon` ONLY IF `status = 'published'`.
        * *Write Rule:* Only users with `profiles.role = 'researcher'` or `'admin'` can INSERT/UPDATE.
    3.  **Auth Middleware:** Protect `/dashboard/*` routes so only logged-in users can access them.
* **Critical Constraint:** Never expose the raw `auth.users` table to the frontend. Always query the `profiles` table.

**WORKING NOW CONTEXT (PHASE 3: GOVERNANCE & SECURITY)**
* **Focus:** Authentication, RBAC, and Row Level Security.
* **Tasks:** Implement `profiles` table, link to Supabase Auth, and apply RLS/Triggers.
* **Constraint:** "The Academic Shield" - Public (Read Published), Researcher (Write/Draft), Admin (Publish).
* **Tech:** Drizzle ORM for Schema, Raw SQL for RLS/Triggers.